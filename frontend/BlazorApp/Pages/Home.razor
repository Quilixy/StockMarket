@page "/"
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Home</PageTitle>

<h1>@greetingMessage</h1>

<p>Welcome to your new app.</p>

@if (balance != null)
{
    <p>Current Balance: @balance</p>
    <div>
        <label for="balanceCardCode">Enter BalanceCard Code:</label>
        <input id="balanceCardCode" @bind="balanceCardCode" />
        <button @onclick="UseBalanceCard">Use BalanceCard</button>
    </div>
}
else if (loading)
{
    <p>Loading balance...</p>
}
else
{
    <p>You are not logged in.</p>
}

@code {
    private string greetingMessage = "Hello, world!";
    private decimal? balance;
    private bool loading = true;
    private string balanceCardCode;

    protected override async Task OnInitializedAsync()
    {
        var rememberMe = await localStorage.GetItemAsync<bool>("rememberMe");

        if (rememberMe)
        {
            var username = await localStorage.GetItemAsync<string>("username");
            greetingMessage = $"Merhaba, {username}!";

            // API'den bakiyeyi al
            await LoadBalanceAsync();
        }
        else
        {
            loading = false;
        }
    }

    private async Task LoadBalanceAsync()
    {
        try
        {
            var token = await localStorage.GetItemAsync<string>("token");

            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
                var response = await Http.GetAsync("http://localhost:5284/api/balance");

                if (response.IsSuccessStatusCode)
                {
                    var balanceResponse = await response.Content.ReadFromJsonAsync<BalanceResponse>();
                    balance = balanceResponse?.Balance;
                }
                else
                {
                    // Hata yönetimi
                    Console.WriteLine("Failed to load balance.");
                }
            }
            else
            {
                // Token yoksa
                Console.WriteLine("No token found.");
            }
        }
        catch (Exception ex)
        {
            // Hata yönetimi
            Console.WriteLine($"Error loading balance: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task UseBalanceCard()
    {
        if (string.IsNullOrWhiteSpace(balanceCardCode))
        {
            Console.WriteLine("BalanceCard code is empty.");
            return;
        }

        try
        {
            var token = await localStorage.GetItemAsync<string>("token");

            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
                var request = new BalanceCardRequest { Code = balanceCardCode };
                var response = await Http.PostAsJsonAsync("http://localhost:5284/api/balancecard/use", request);

                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine("BalanceCard used successfully.");
                    // Gerekirse bakiye güncellemesini tekrar yükleyin
                    await LoadBalanceAsync();
                }
                else
                {
                    // Hata yönetimi
                    Console.WriteLine("Failed to use BalanceCard.");
                }
            }
            else
            {
                // Token yoksa
                Console.WriteLine("No token found.");
            }
        }
        catch (Exception ex)
        {
            // Hata yönetimi
            Console.WriteLine($"Error using BalanceCard: {ex.Message}");
        }
    }

    public class BalanceResponse
    {
        public decimal Balance { get; set; }
    }

    public class BalanceCardRequest
    {
        public string Code { get; set; }
    }
}
