@page "/admin"
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager Navigation

<PageTitle>Admin Page</PageTitle>

@if (isAdmin)
{
    <h1>Welcome to the Admin Page</h1>
    <p>This content is only for administrators.</p>
    <UserManagement />

    <button @onclick="NavigateToPage1">Add Balance Card</button>
    <button @onclick="NavigateToPage2">User Management</button>

    @if (systemBalance.HasValue)
    {
        <div>
            <h2>System Balance: @systemBalance.Value</h2>
        </div>
    }
    else
    {
        <p>Unable to fetch system balance.</p>
    }
}
else if (loading)
{
    <p>Loading...</p>
}
else
{
    <p>You do not have access to this page.</p>
}


@code {
    private bool isAdmin = false;
    private bool loading = true;
    private decimal? systemBalance;

    protected override async Task OnInitializedAsync()
    {
        var token = await localStorage.GetItemAsync<string>("token");

        if (!string.IsNullOrEmpty(token))
        {
            var role = GetRoleFromToken(token);
            Console.WriteLine($"Token role: {role}");

            if (role == "Admin") 
            {
                isAdmin = true;

                // Sistem bakiyesini al
                await FetchSystemBalanceAsync();
            }
            else
            {
                Console.WriteLine("User is not an admin.");
                Navigation.NavigateTo("/");
            }
        }
        else
        {
            Console.WriteLine("Token not found.");
            Navigation.NavigateTo("/login");
        }

        loading = false;
    }

    private string GetRoleFromToken(string token)
    {
        var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
        var jsonToken = handler.ReadToken(token) as System.IdentityModel.Tokens.Jwt.JwtSecurityToken;

        if (jsonToken == null)
        {
            Console.WriteLine("Invalid token.");
            return null;
        }

        var role = jsonToken.Claims.FirstOrDefault(claim => claim.Type == "role")?.Value;

        if (role == null)
        {
            Console.WriteLine("Role claim not found.");
        }

        return role;
    }

    private async Task FetchSystemBalanceAsync()
    {
        try
        {
            var token = await localStorage.GetItemAsync<string>("token");

            if (string.IsNullOrEmpty(token))
            {
                Console.WriteLine("Token not found.");
                return;
            }

            var requestMessage = new HttpRequestMessage(HttpMethod.Get, "http://localhost:5284/api/balance/system");
            requestMessage.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(requestMessage);

            if (response.IsSuccessStatusCode)
            {
                var jsonResponse = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Raw balance response: {jsonResponse}");

                var balanceResponse = System.Text.Json.JsonSerializer.Deserialize<BalanceResponse>(jsonResponse);

                if (balanceResponse != null)
                {
                    systemBalance = balanceResponse.Balance;
                }
                else
                {
                    Console.WriteLine("Failed to parse system balance.");
                }
            }
            else
            {
                Console.WriteLine($"Failed to fetch system balance. Status code: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred while fetching system balance: {ex.Message}");
        }
    }

public class BalanceResponse
{
    public decimal Balance { get; set; }
}


    private void NavigateToPage1()
    {
        Navigation.NavigateTo("/admin/balancecard"); // Burada "/page1" yerine gitmek istediğiniz sayfanın yolu yazılmalı
    }

    private void NavigateToPage2()
    {
        Navigation.NavigateTo("/admin/usermanagement"); // Burada "/page2" yerine gitmek istediğiniz sayfanın yolu yazılmalı
    }
}
