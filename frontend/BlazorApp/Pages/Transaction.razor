@page "/transaction"
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@using System.Net.Http.Headers
@using System.Text.Json
@using System.Text
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Transaction</PageTitle>

<h3>New Transaction</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}

<EditForm Model="@transactionModel" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <label for="transactionType">Transaction Type</label>
    <select id="transactionType" @onchange="OnTransactionTypeChanged">
        <option value="">Select a transaction type</option>
        <option value="true">Purchase</option>
        <option value="false">Sell</option>
    </select>

    <label for="stock">Select Stock</label>
    <select id="stock" @onchange="OnStockIdChanged">
        <option value="">Select a stock</option>
        @foreach (var stock in stocks)
        {
            <option value="@stock.Symbol">@stock.Name</option>
        }
    </select>

    <label for="quantity">Quantity</label>
    <InputNumber id="quantity" @bind-Value="transactionModel.Quantity" required />

    <label for="price">Price</label>
    <InputNumber id="price" @bind-Value="selectedStockPrice" disabled />

    <button type="submit">Submit</button>
</EditForm>

@code {
    private TransactionModel transactionModel = new TransactionModel();
    private List<StockModel> stocks = new List<StockModel>();
    private decimal selectedStockPrice;
    private string errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetAsync("http://localhost:5284/api/stock");
            if (response.IsSuccessStatusCode)
            {
                var responseData = await response.Content.ReadAsStringAsync();
                stocks = JsonSerializer.Deserialize<List<StockModel>>(responseData, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            else
            {
                errorMessage = $"Failed to load stocks. Status Code: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private void OnTransactionTypeChanged(ChangeEventArgs e)
    {
        if (e.Value != null)
        {
            var selectedValue = e.Value.ToString();
            if (bool.TryParse(selectedValue, out bool isPurchase))
            {
                transactionModel.IsPurchase = isPurchase;
            }
        }
    }

    private void OnStockIdChanged(ChangeEventArgs e)
    {
        var selectedSymbol = e.Value.ToString();
        if (!string.IsNullOrEmpty(selectedSymbol))
        {
            transactionModel.Symbol = selectedSymbol;
            UpdateStockPrice(selectedSymbol);
        }
    }

    private void UpdateStockPrice(string symbol)
    {
        var selectedStock = stocks.FirstOrDefault(s => s.Symbol == symbol);
        if (selectedStock != null)
        {
            selectedStockPrice = selectedStock.Price;
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            var token = await localStorage.GetItemAsync<string>("token");
            var endpoint = transactionModel.IsPurchase ? "http://localhost:5284/api/transaction/purchase" : "http://localhost:5284/api/transaction/sell";

            var requestBody = new
            {
                symbol = transactionModel.Symbol,
                quantity = transactionModel.Quantity
            };

            var request = new HttpRequestMessage(HttpMethod.Post, endpoint);
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
            request.Content = new StringContent(JsonSerializer.Serialize(requestBody), Encoding.UTF8, "application/json");

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                transactionModel = new TransactionModel(); // Formu temizle
                selectedStockPrice = 0; // Fiyatı sıfırla
            }
            else
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"API request failed: {response.ReasonPhrase}, {responseContent}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    public class TransactionModel
    {
        public string Symbol { get; set; }
        public int Quantity { get; set; }
        public bool IsPurchase { get; set; }
    }

    public class StockModel
    {
        public string Symbol { get; set; }
        public string Name { get; set; }
        public decimal Price { get; set; }
    }
}
